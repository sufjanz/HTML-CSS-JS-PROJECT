<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home - Budget App</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .section-list {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background-color: #f9f9f9;
      min-height: calc(100vh - 120px);
    }

    .section-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 400px;
      padding: 16px 20px;
      margin: 8px 0;
      background-color: white;
      border: 2px solid #007BFF;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .section-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .section-info {
      display: flex;
      flex-direction: column;
    }

    .section-name {
      font-weight: bold;
      font-size: 18px;
      color: #333;
      margin-bottom: 4px;
    }

    .section-date {
      font-size: 12px;
      color: #666;
    }

    .section-price {
      font-weight: bold;
      font-size: 18px;
      color: #007BFF;
    }

    .total-summary {
      width: 100%;
      max-width: 400px;
      padding: 20px;
      margin: 20px 0;
      background-color: white;
      border: 2px solid #007BFF;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .total-label {
      font-size: 16px;
      color: #666;
      margin-bottom: 8px;
    }

    .total-amount {
      font-size: 24px;
      font-weight: bold;
      color: #007BFF;
    }

    .budget-comparison {
      margin-top: 12px;
      font-size: 14px;
    }

    .remaining-positive {
      color: #28a745;
    }

    .remaining-negative {
      color: #dc3545;
    }

    .no-items {
      text-align: center;
      color: #666;
      font-style: italic;
      margin: 40px 0;
      padding: 20px;
    }

    .refresh-btn {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 20px;
      border: 2px solid #007BFF;
      background-color: white;
      color: #007BFF;
      cursor: pointer;
      margin-bottom: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    .refresh-btn:hover {
      background-color: #007BFF;
      color: white;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-left">
      <img src="/images/user.png" alt="User" class="user-icon" />
      <span class="user-name">Name</span>
    </div>
   
    <div class="header-center">
      <img src="/images/home.png" alt="App Logo" class="app-logo" />
    </div>
    
    <div class="header-right">
      <button class="budget-amount" onclick="window.location.href='budget.html'">$0</button>
    </div>
  </header>
    
  <main class="section-list">
    <button class="refresh-btn" onclick="loadItemsFromServer()">â†» Refresh</button>
    
    <div class="total-summary">
      <div class="total-label">Total Expenses</div>
      <div class="total-amount" id="totalAmount">$0.00</div>
      <div class="budget-comparison" id="budgetComparison"></div>
    </div>
    
    <div id="itemsContainer">
      <div class="no-items">No expenses added yet.<br>Click the + button to add items.</div>
    </div>
  </main>

  <footer>
    <div class="footer-item">
      <button class="footer-button home" onclick="window.location.href='homepage.html'">
        <img src="/images/home.png" alt="Home" class="small-icon" />
      </button>
    </div>

    <div class="footer-item">
      <button class="footer-button plus" onclick="window.location.href='createmenu.html'">+</button>
    </div>

    <div class="footer-item">
      <button class="footer-button user" onclick="window.location.href='accounts.html'">
        <img src="/images/user.png" alt="User" class="small-icon" />
      </button>
    </div>
  </footer>

  <script>
    let items = [];
    let currentBudget = 0;

    // Load budget from server
    function loadBudget() {
      fetch('/get-budget')
        .then(res => res.json())
        .then(data => {
          currentBudget = data.budget || 0;
          const budgetBtn = document.querySelector('.budget-amount');
          if (budgetBtn) {
            budgetBtn.textContent = `$${currentBudget.toFixed(2)}`;
          }
          updateBudgetComparison();
        })
        .catch(() => {
          currentBudget = 0;
          const budgetBtn = document.querySelector('.budget-amount');
          if (budgetBtn) {
            budgetBtn.textContent = `$0.00`;
          }
          updateBudgetComparison();
        });
    }

    // Load items from localStorage
    function loadItemsFromStorage() {
      const storedItems = localStorage.getItem('budgetAppItems');
      if (storedItems) {
        try {
          items = JSON.parse(storedItems);
          renderItems();
        } catch (error) {
          console.error('Error parsing stored items:', error);
          items = [];
          renderItems();
        }
      } else {
        renderItems();
      }
    }

    // Load items from server
    function loadItemsFromServer() {
      fetch('/get-items-from-file')
        .then(response => {
          if (!response.ok) throw new Error('Failed to load from server');
          return response.json();
        })
        .then(data => {
          items = data.items || [];
          
          // Update localStorage with server data
          localStorage.setItem('budgetAppItems', JSON.stringify(items));
          
          renderItems();
        })
        .catch(error => {
          console.error('Error loading from server:', error);
          // Fall back to localStorage if server fails
          loadItemsFromStorage();
        });
    }

    // Render items on homepage
    function renderItems() {
      const container = document.getElementById('itemsContainer');
      
      if (items.length === 0) {
        container.innerHTML = '<div class="no-items">No expenses added yet.<br>Click the + button to add items.</div>';
        updateTotal();
        return;
      }
      
      container.innerHTML = '';
      
      // Sort items by creation date (newest first)
      const sortedItems = [...items].sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return dateB - dateA;
      });
      
      sortedItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'section-item';
        itemDiv.onclick = () => window.location.href = 'createmenu.html';
        
        const createdDate = item.createdAt ? 
          new Date(item.createdAt).toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric'
          }) : 'Unknown date';
        
        itemDiv.innerHTML = `
          <div class="section-info">
            <div class="section-name">${item.name}</div>
            <div class="section-date">Added ${createdDate}</div>
          </div>
          <div class="section-price">$${parseFloat(item.price).toFixed(2)}</div>
        `;
        
        container.appendChild(itemDiv);
      });
      
      updateTotal();
    }

    // Update total amount and budget comparison
    function updateTotal() {
      const total = items.reduce((sum, item) => sum + parseFloat(item.price), 0);
      document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
      updateBudgetComparison();
    }

    // Update budget comparison
    function updateBudgetComparison() {
      const total = items.reduce((sum, item) => sum + parseFloat(item.price), 0);
      const remaining = currentBudget - total;
      const comparisonDiv = document.getElementById('budgetComparison');
      
      if (currentBudget === 0) {
        comparisonDiv.innerHTML = 'Set a budget to track spending';
        comparisonDiv.className = 'budget-comparison';
      } else if (remaining >= 0) {
        comparisonDiv.innerHTML = `$${remaining.toFixed(2)} remaining from budget`;
        comparisonDiv.className = 'budget-comparison remaining-positive';
      } else {
        comparisonDiv.innerHTML = `$${Math.abs(remaining).toFixed(2)} over budget`;
        comparisonDiv.className = 'budget-comparison remaining-negative';
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadBudget();
      loadItemsFromStorage();
      
      // Auto-refresh from server every 30 seconds
      setInterval(loadItemsFromServer, 30000);
    });
  </script>
</body>
</html>