<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Accounts - Budget App</title>
<link rel="stylesheet" href="/css/style.css" />
<style>
  main.account-main {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px 100px;
    background-color: #f9f9f9;
    min-height: calc(100vh - 60px - 60px);
  }

  .account-user-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    margin-bottom: 16px;
    padding: 10px;
    border: 2px solid #007BFF;
    border-radius: 50%;
    background-color: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }

  .account-user-image:hover {
    transform: scale(1.05);
    border-color: #0056b3;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
  }

  .main-avatar-container {
    position: relative;
    display: inline-block;
    margin-bottom: 16px;
  }

  .account-name {
    font-size: 28px;
    font-weight: bold;
    color: black;
    margin-bottom: 32px;
  }

  .account-buttons {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
  }

  .btn {
    padding: 12px 36px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 20px;
    border: 2px solid #007BFF;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
    min-width: 120px;
    text-align: center;
  }

  .login-btn {
    background-color: white;
    color: #007BFF;
    border-color: #007BFF;
  }
  .login-btn:hover, .login-btn.active {
    background-color: #007BFF;
    color: white;
  }

  .signup-btn {
    background-color: #007BFF;
    color: white;
    border-color: #007BFF;
  }
  .signup-btn:hover, .signup-btn.active {
    background-color: white;
    color: #007BFF;
    border-color: #007BFF;
  }

  .form-container {
    display: none;
    background-color: white;
    padding: 30px;
    border-radius: 12px;
    border: 2px solid #007BFF;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 400px;
  }

  .form-container.active {
    display: block;
  }

  .form-title {
    font-size: 24px;
    font-weight: bold;
    color: #007BFF;
    text-align: center;
    margin-bottom: 25px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
    font-size: 16px;
  }

  .form-input {
    width: 100%;
    padding: 12px 16px;
    font-size: 16px;
    border: 2px solid #007BFF;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }

  .form-input:focus {
    outline: none;
    border-color: #0056b3;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .form-input.error {
    border-color: #dc3545;
  }

  .error-message {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .form-submit {
    width: 100%;
    padding: 14px;
    font-size: 18px;
    font-weight: bold;
    background-color: #007BFF;
    color: white;
    border: 2px solid #007BFF;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 10px;
  }

  .form-submit:hover {
    background-color: #0056b3;
  }

  .form-submit:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
  }

  .success-message {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 12px;
    border-radius: 8px;
    margin-top: 15px;
    text-align: center;
    display: none;
  }

  .success-message.show {
    display: block;
  }

  .switch-form {
    text-align: center;
    margin-top: 20px;
    color: #666;
  }

  .switch-form a {
    color: #007BFF;
    text-decoration: none;
    font-weight: bold;
  }

  .switch-form a:hover {
    text-decoration: underline;
  }

  .user-profile {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background-color: white;
    border: 2px solid #007BFF;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 400px;
    margin-bottom: 20px;
  }

  .user-names {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
  }

  .user-first-name,
  .user-last-name {
    font-size: 24px;
    font-weight: bold;
    color: #007BFF;
    padding: 8px 16px;
    background-color: #f8f9fa;
    border: 2px solid #007BFF;
    border-radius: 8px;
  }

  .logout-btn {
    padding: 8px 24px;
    font-size: 16px;
    font-weight: bold;
    background-color: #dc3545;
    color: white;
    border: 2px solid #dc3545;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .logout-btn:hover {
    background-color: #c82333;
    border-color: #c82333;
  }

  .upload-hint {
    color: #666;
    font-size: 12px;
    margin-top: 5px;
    text-align: center;
  }

  /* Hide file input completely */
  #profileAvatarInput {
    display: none;
  }
</style>
</head>
<body>
<header class="app-header">
  <div class="header-left">
    <img src="/images/user.png" alt="User" class="user-icon" />
    <span class="user-name">Account</span>
  </div>
  <div class="header-center">
    <img src="/images/user.png" alt="App Logo" class="app-logo" />
  </div>
  <div class="header-right">
    <button class="budget-amount" id="budgetAmountBtn" onclick="window.location.href='budget.html'">$0</button>
  </div>
</header>

<main class="account-main">
  
  <h1 class="account-name">Account</h1>

  <!-- User Profile Section (shown when logged in) -->
  <div class="user-profile" id="userProfile" style="display: none;">
    <div class="main-avatar-container">
      <img src="/images/user.png" alt="User Avatar" class="account-user-image" id="profileMainAvatar" onclick="document.getElementById('profileAvatarInput').click()">
      <input type="file" id="profileAvatarInput" accept="image/*" onchange="handleProfileMainAvatarUpload(event)">
    </div>
    
    <div class="user-names">
      <span class="user-first-name" id="userFirstName">John</span>
      <span class="user-last-name" id="userLastName">Doe</span>
    </div>
    
    <button class="logout-btn" id="logoutBtn" onclick="logout()">Log Out</button>
  </div>

  <div class="account-buttons">
    <button class="btn login-btn" id="loginBtn" onclick="showLoginForm()">Login</button>
    <button class="btn signup-btn" id="signupBtn" onclick="showSignupForm()">Sign Up</button>
  </div>

  <!-- Login Form -->
  <div class="form-container" id="loginForm">
    <div class="form-title">Login</div>
    <form id="loginFormElement">
      <div class="form-group">
        <label class="form-label" for="loginEmail">Email</label>
        <input type="email" class="form-input" id="loginEmail" required>
        <div class="error-message" id="loginEmailError">Please enter a valid email address</div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="loginPassword">Password</label>
        <input type="password" class="form-input" id="loginPassword" required>
        <div class="error-message" id="loginPasswordError">Password is required</div>
      </div>
      
      <button type="submit" class="form-submit" id="loginSubmit">Login</button>
      <div class="success-message" id="loginSuccess">Login successful! Redirecting...</div>
    </form>
    
    <div class="switch-form">
      Don't have an account? <a href="#" onclick="showSignupForm()">Sign up here</a>
    </div>
  </div>

  <!-- Signup Form -->
  <div class="form-container" id="signupForm">
    <div class="form-title">Sign Up</div>
    <form id="signupFormElement">
      <div class="form-group">
        <label class="form-label" for="signupEmail">Email</label>
        <input type="email" class="form-input" id="signupEmail" required>
        <div class="error-message" id="signupEmailError">Please enter a valid email address</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="signupFirstName">First Name</label>
        <input type="text" class="form-input" id="signupFirstName" required>
        <div class="error-message" id="signupFirstNameError">First name is required</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="signupLastName">Last Name</label>
        <input type="text" class="form-input" id="signupLastName" required>
        <div class="error-message" id="signupLastNameError">Last name is required</div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="signupPassword">Password</label>
        <input type="password" class="form-input" id="signupPassword" required>
        <div class="error-message" id="signupPasswordError">Password must be at least 6 characters</div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="confirmPassword">Confirm Password</label>
        <input type="password" class="form-input" id="confirmPassword" required>
        <div class="error-message" id="confirmPasswordError">Passwords do not match</div>
      </div>
      
      <button type="submit" class="form-submit" id="signupSubmit">Sign Up</button>
      <div class="success-message" id="signupSuccess">Account created successfully! You can now login.</div>
    </form>
    
    <div class="switch-form">
      Already have an account? <a href="#" onclick="showLoginForm()">Login here</a>
    </div>
  </div>
</main>

<footer>
  <div class="footer-item">
    <button class="footer-button home" onclick="window.location.href='homepage.html'">
      <img src="/images/home.png" alt="Home" class="small-icon" />
    </button>
  </div>

  <div class="footer-item">
    <button class="footer-button plus" onclick="window.location.href='createmenu.html'">+</button>
  </div>

  <div class="footer-item">
    <button class="footer-button user" onclick="window.location.href='accounts.html'">
      <img src="/images/user.png" alt="User" class="small-icon" />
    </button>
  </div>
</footer>

<script>
  // Load budget and calculate remaining amount on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadRemainingBudget();
    checkUserSession();
  });

  function loadRemainingBudget() {
    Promise.all([
      fetch('/get-budget').then(res => res.json()).catch(() => ({ budget: 0 })),
      fetch('/get-tasks').then(res => res.json()).catch(() => ({ tasks: [] }))
    ])
    .then(([budgetData, tasksData]) => {
      const currentBudget = budgetData.budget || 0;
      const tasks = tasksData.tasks || [];
      const totalSpent = tasks.reduce((sum, task) => sum + parseFloat(task.price || 0), 0);
      const remaining = currentBudget - totalSpent;
      
      const budgetBtn = document.getElementById('budgetAmountBtn');
      if (budgetBtn) {
        budgetBtn.textContent = `$${remaining.toFixed(2)}`;
      }
    })
    .catch(() => {
      const budgetBtn = document.getElementById('budgetAmountBtn');
      if (budgetBtn) {
        budgetBtn.textContent = `$0.00`;
      }
    });
  }

  // Form switching functions
  function showLoginForm() {
    document.getElementById('loginForm').classList.add('active');
    document.getElementById('signupForm').classList.remove('active');
    document.getElementById('loginBtn').classList.add('active');
    document.getElementById('signupBtn').classList.remove('active');
    clearForms();
  }

  function showSignupForm() {
    document.getElementById('signupForm').classList.add('active');
    document.getElementById('loginForm').classList.remove('active');
    document.getElementById('signupBtn').classList.add('active');
    document.getElementById('loginBtn').classList.remove('active');
    clearForms();
  }

  function clearForms() {
    // Clear all form inputs
    document.querySelectorAll('.form-input').forEach(input => {
      input.value = '';
      input.classList.remove('error');
    });
    
    // Hide all error messages
    document.querySelectorAll('.error-message').forEach(error => {
      error.classList.remove('show');
    });
    
    // Hide success messages
    document.querySelectorAll('.success-message').forEach(success => {
      success.classList.remove('show');
    });
  }

  // Email validation function
  function isValidEmail(email) {
    return email.includes('@') && email.includes('.');
  }

  // Show error message
  function showError(inputId, errorId, message) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(errorId);
    input.classList.add('error');
    error.textContent = message;
    error.classList.add('show');
  }

  // Hide error message
  function hideError(inputId, errorId) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(errorId);
    input.classList.remove('error');
    error.classList.remove('show');
  }

  function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.textContent = message;
    successDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #d4edda;
      color: #155724;
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #c3e6cb;
      z-index: 1000;
      font-weight: bold;
    `;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
      if (document.body.contains(successDiv)) {
        document.body.removeChild(successDiv);
      }
    }, 3000);
  }

  // Profile avatar upload - SIMPLE VERSION THAT WORKS
  function handleProfileMainAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('Please select a valid image file');
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      alert('Image size must be less than 5MB');
      return;
    }

    const avatar = document.getElementById('profileMainAvatar');
    avatar.style.opacity = '0.5';

    const reader = new FileReader();
    reader.onload = function(e) {
      const base64Image = e.target.result;
      
      // Update avatar immediately
      avatar.src = base64Image;
      avatar.style.opacity = '1';
      
      // Save to localStorage
      localStorage.setItem('userAvatar', base64Image);
      
      showSuccessMessage('Avatar updated successfully!');
    };

    reader.onerror = function() {
      avatar.style.opacity = '1';
      alert('Failed to upload avatar. Please try again.');
    };

    reader.readAsDataURL(file);
    event.target.value = '';
  }

  // Load user avatar when checking session
  function checkUserSession() {
    fetch('/check-session')
      .then(res => res.json())
      .then(data => {
        if (data.loggedIn) {
          // Show user profile
          document.getElementById('userProfile').style.display = 'flex';
          document.querySelector('.account-buttons').style.display = 'none';
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('signupForm').style.display = 'none';
          
          // Update user names if available
          if (data.firstName) {
            document.getElementById('userFirstName').textContent = data.firstName;
          }
          if (data.lastName) {
            document.getElementById('userLastName').textContent = data.lastName;
          }

          // Add admin dashboard button if user is admin
          if (data.isAdmin) {
            const adminBtn = document.createElement('button');
            adminBtn.textContent = '🛡️ Admin Dashboard';
            adminBtn.className = 'logout-btn';
            adminBtn.style.background = '#28a745';
            adminBtn.style.marginBottom = '10px';
            adminBtn.onclick = () => window.location.href = 'admin.html';
            
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.parentNode.insertBefore(adminBtn, logoutBtn);
          }
          
          // Load avatar from localStorage
          const savedAvatar = localStorage.getItem('userAvatar');
          if (savedAvatar) {
            document.getElementById('profileMainAvatar').src = savedAvatar;
          }
        } else {
          // Show login/signup forms
          document.getElementById('userProfile').style.display = 'none';
          document.querySelector('.account-buttons').style.display = 'flex';
          showLoginForm();
        }
      })
      .catch(error => {
        console.error('Session check error:', error);
        // Show login/signup forms on error
        document.getElementById('userProfile').style.display = 'none';
        document.querySelector('.account-buttons').style.display = 'flex';
        showLoginForm();
      });
  }

  function logout() {
    // Clear saved avatar on logout
    localStorage.removeItem('userAvatar');
    
    fetch('/logout', { method: 'POST' })
      .then(() => {
        // Refresh page to show login forms
        window.location.reload();
      })
      .catch(error => {
        console.error('Logout error:', error);
        // Refresh anyway
        window.location.reload();
      });
  }

  // Login form validation and submission
  document.getElementById('loginFormElement').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    let isValid = true;

    // Validate email
    if (!email) {
      showError('loginEmail', 'loginEmailError', 'Email is required');
      isValid = false;
    } else if (!isValidEmail(email)) {
      showError('loginEmail', 'loginEmailError', 'Please enter a valid email address');
      isValid = false;
    } else {
      hideError('loginEmail', 'loginEmailError');
    }

    // Validate password
    if (!password) {
      showError('loginPassword', 'loginPasswordError', 'Password is required');
      isValid = false;
    } else {
      hideError('loginPassword', 'loginPasswordError');
    }

    if (isValid) {
      // Disable submit button
      const submitBtn = document.getElementById('loginSubmit');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';

      // Send login request
      fetch('/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('loginSuccess').classList.add('show');
          setTimeout(() => {
            // Redirect to admin dashboard if user is admin, otherwise homepage
            if (data.isAdmin) {
              window.location.href = 'admin.html';
            } else {
              window.location.href = 'homepage.html';
            }
          }, 2000);
        } else {
          showError('loginPassword', 'loginPasswordError', data.message || 'Invalid email or password');
        }
      })
      .catch(error => {
        console.error('Login error:', error);
        showError('loginPassword', 'loginPasswordError', 'Login failed. Please try again.');
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      });
    }
  });

  // Signup form validation and submission
  document.getElementById('signupFormElement').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const firstName = document.getElementById('signupFirstName').value.trim();
    const lastName = document.getElementById('signupLastName').value.trim();
    let isValid = true;

    // Validate email
    if (!email) {
      showError('signupEmail', 'signupEmailError', 'Email is required');
      isValid = false;
    } else if (!isValidEmail(email)) {
      showError('signupEmail', 'signupEmailError', 'Please enter a valid email address');
      isValid = false;
    } else {
      hideError('signupEmail', 'signupEmailError');
    }

    // Validate first name
    if (!firstName) {
      showError('signupFirstName', 'signupFirstNameError', 'First name is required');
      isValid = false;
    } else {
      hideError('signupFirstName', 'signupFirstNameError');
    }

    // Validate last name
    if (!lastName) {
      showError('signupLastName', 'signupLastNameError', 'Last name is required');
      isValid = false;
    } else {
      hideError('signupLastName', 'signupLastNameError');
    }

    // Validate password
    if (!password) {
      showError('signupPassword', 'signupPasswordError', 'Password is required');
      isValid = false;
    } else if (password.length < 6) {
      showError('signupPassword', 'signupPasswordError', 'Password must be at least 6 characters');
      isValid = false;
    } else {
      hideError('signupPassword', 'signupPasswordError');
    }

    // Validate confirm password
    if (!confirmPassword) {
      showError('confirmPassword', 'confirmPasswordError', 'Please confirm your password');
      isValid = false;
    } else if (password !== confirmPassword) {
      showError('confirmPassword', 'confirmPasswordError', 'Passwords do not match');
      isValid = false;
    } else {
      hideError('confirmPassword', 'confirmPasswordError');
    }

    if (isValid) {
      // Disable submit button
      const submitBtn = document.getElementById('signupSubmit');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating Account...';

      // Send signup request
      fetch('/signup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password, firstName, lastName })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('signupSuccess').classList.add('show');
          setTimeout(() => {
            showLoginForm();
          }, 2000);
        } else {
          showError('signupEmail', 'signupEmailError', data.message || 'Email already exists');
        }
      })
      .catch(error => {
        console.error('Signup error:', error);
        showError('signupEmail', 'signupEmailError', 'Signup failed. Please try again.');
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign Up';
      });
    }
  });

  // Real-time validation
  document.getElementById('loginEmail').addEventListener('input', function() {
    const email = this.value.trim();
    if (email && isValidEmail(email)) {
      hideError('loginEmail', 'loginEmailError');
    }
  });

  document.getElementById('signupEmail').addEventListener('input', function() {
    const email = this.value.trim();
    if (email && isValidEmail(email)) {
      hideError('signupEmail', 'signupEmailError');
    }
  });

  document.getElementById('signupPassword').addEventListener('input', function() {
    const password = this.value;
    if (password.length >= 6) {
      hideError('signupPassword', 'signupPasswordError');
    }
    
    // Check confirm password match
    const confirmPassword = document.getElementById('confirmPassword').value;
    if (confirmPassword && password === confirmPassword) {
      hideError('confirmPassword', 'confirmPasswordError');
    }
  });

  document.getElementById('confirmPassword').addEventListener('input', function() {
    const confirmPassword = this.value;
    const password = document.getElementById('signupPassword').value;
    if (confirmPassword && password === confirmPassword) {
      hideError('confirmPassword', 'confirmPasswordError');
    }
  });
</script>
</body>
</html>
